apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: translation-essprod
spec:
  arguments:
    parameters:
      - name: localelist
        value: 'de-DE|en-GB...'
      - name: translationid
        value: '1234abc|456def|789ghi... '
  entrypoint: template
  imagePullSecrets:
    - name: cnvwebshop
  metrics:
    prometheus: []
  onExit: exit-handler    
  templates:
    - name: template
      steps:
        - - arguments:
              parameters:
                - name: localelist
                  value: '{{workflow.parameters.localelist}}'
                - name: translationid
                  value: '{{workflow.parameters.translationid}}'
            name: step1
            template: step1
    # Step 1 - Workflow Job
    - inputs:
        parameters:
          - name: localelist
          - name: translationid
      metrics:
        prometheus: []
      name: step1
      outputs:
        parameters: []
      script:
        args: []
        command:
          - /bin/sh
        env:
          - name: LOCALELIST
            value: '{{workflow.parameters.localelist}}'
          - name: TRANSLATIONID
            value: '{{workflow.parameters.translationid}}'
          - name: ESSPROD
            value: '5f1afbf752faff00018681f5'
          - name: CONTENTID
            value: '5f1afbfecff47e0001e5b3d0' # ESSPROD Content Repo ID
          - name: CLIENTID
            value: 'c81b7886-f62b-4cad-ba01-02ca63026588'
          - name: CLIENTSECRET
            valueFrom:
              secretKeyRef:
                key: CLIENTSECRET
                name: dc-cli
        image: 'cnvwebshop.azurecr.io/dc-cli:95ad01fc'
        source: |
          dc-cli configure --clientId $CLIENTID --clientSecret $CLIENTSECRET --hubId $CATPROD

          dc-cli content-item workflow --facet "locale:/$LOCALELIST/, workflowId:/$TRANSLATIONID/" --repoId $CONTENTID -targetWorkflowLabel "Ready for Translation"
    - name: exit-handler
      steps:
        - - arguments:
              parameters:
                - name: status
                  value: '{{workflow.status}}'
                - name: failures
                  value: '{{workflow.failures}}'
            name: notify-teams-failure
            templateRef:
              name: teams-exithandler
              template: notify-teams-failure
            when: '{{workflow.status}} != Succeeded'          
  ttlStrategy:
    secondsAfterCompletion: 600
    secondsAfterFailure: 259200
    secondsAfterSuccess: 600
